name: Reusable Build & Push

on:
  workflow_call:
    inputs:
      app_name:
        description: "Application name"
        required: true
        type: string
      system_name:
        description: "System name"
        required: true
        type: string
      environment:
        description: "Deployment environment (e.g., dev, test, prod)"
        required: true
        type: string
      docker-build-context:
        description: "Build context"
        required: false
        default: "./"
        type: string
      container_registry:
        description: "Container registry URL"
        required: false
        default: "ghcr.io"
        type: string
      dockerfile:
        description: "Path to Dockerfile"
        required: false
        default: "Dockerfile"
        type: string
      tags:
        description: "Image tags (comma-separated)"
        required: true
        type: string
      push-image:
        description: "Push the image to the registry"
        required: false
        default: false
        type: boolean
      build-args:
        description: "Build arguments (key=value, comma-separated)"
        required: false
        type: string
      version:
        description: "Semantic version"
        required: false
        type: string
      no-cache:
        description: "Whether to disable the build cache"
        required: false
        type: boolean
    secrets:
      GH_TOKEN:
        description: "GitHub token"
        required: true
      AZURE_CLIENT_ID:
        description: "Azure AD Application Client ID"
        required: false
      AZURE_TENANT_ID:
        description: "Azure Tenant ID"
        required: false
      CODECOV_TOKEN:
        description: "Code coverage access token"
        required: false
      SLACK_WEBHOOK_URL:
        description: "Slack Webhook URL"
        required: false
      AUTH0_SECRET:
        description: "Auth0 Secret for secure operations"
        required: false
      AUTH0_CLIENT_SECRET:
        description: "Auth0 Client Secret"
        required: false
      AUTH0_CLIENT_ID:
        description: "Auth0 Client ID"
        required: false
      AUTH0_DOMAIN:
        description: "Auth0 Domain"
        required: false
      AUTH0_AUDIENCE:
        description: "Auth0 Audience"
        required: false
jobs:
  build:
    name: Build, test, publish ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      ENVIRONMENT: ${{ inputs.environment }}
      NODE_ENV: ${{ inputs.environment }}
    steps:
      - name: Check required inputs
        run: |
          # Explicit checks for required inputs
          [[ "${{ inputs.app_name }}" ]] || { echo "Parameter 'app_name' is required, but is empty." ; exit 1; }
          [[ "${{ inputs.system_name }}" ]] || { echo "Parameter 'system_name' is required, but is empty." ; exit 1; }
          [[ "${{ inputs.environment }}" ]] || { echo "Parameter 'environment' is required, but is empty." ; exit 1; }
          [[ "${{ inputs.tags }}" ]] || { echo "Parameter 'tags' is required, but is empty." ; exit 1; }
        shell: bash

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Lowercase repository name
        run: |
          echo "REPO=${GITHUB_REPOSITORY@L}" >> $GITHUB_ENV
        shell: bash

      - name: Get federated token for Azure
        shell: bash
        id: get-federated-token
        if: ${{ contains(inputs.container_registry, 'azurecr.io') }}
        run: |
          # Get federated token for Azure
          token=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange" | jq -r '.value')
          echo "::add-mask::$token"
          echo "token=$token" >> "$GITHUB_OUTPUT"

      - name: Login to Azure with federated token
        if: ${{ contains(inputs.container_registry, 'azurecr.io') }}
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }} \
            --federated-token ${{ steps.get-federated-token.outputs.token }}
        shell: bash

      - name: Login to Azure Container Registry
        if: ${{ contains(inputs.container_registry, 'azurecr.io') }}
        run: |
          REGISTRY_NAME=$(echo "${{ inputs.container_registry }}" | cut -d'.' -f1)
          az acr login --name $REGISTRY_NAME
        shell: bash

      - name: Login to GHCR
        if: ${{ contains(inputs.container_registry, 'ghcr.io') }}
        uses: docker/login-action@v3
        with:
          registry: "ghcr.io"
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Create image name
        run: |
          IMAGE_NAME="${{ inputs.container_registry }}/${{ github.actor }}/${{ inputs.system_name }}/${{ inputs.app_name }}-${{ inputs.environment }}"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "🔍 Debug: Repository owner: ${{ github.repository_owner }}"
          echo "🔍 Debug: Repository: ${{ github.repository }}"
          echo "🔍 Debug: Actor: ${{ github.actor }}"
          echo "🔍 Debug: Image name: $IMAGE_NAME"
          echo "🔍 Debug: Tags: ${{ inputs.tags }}"
        shell: bash

      - name: Set meta_flavor environment variable
        run: |
          if [[ "${{ inputs.environment }}" == "prod" ]]; then
            echo "meta_flavor=true" >> $GITHUB_ENV
            echo "image_tag=latest" >> $GITHUB_ENV
          else
            echo "meta_flavor=false" >> $GITHUB_ENV
            echo "image_tag=${{ inputs.environment }}_latest" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          flavor: |
            latest=${{ env.meta_flavor }}
          tags: |
            type=raw,value=${{ env.image_tag }}
            type=raw,value=${{ github.sha }},priority=1000
            type=semver,pattern={{version}},value=${{ inputs.version }},enable=${{ inputs.version != '' }}
            type=ref,event=branch

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.docker-build-context }}
          file: ${{ inputs.dockerfile }}
          tags: ${{ inputs.tags }}
          push: ${{ inputs.push-image }}
          no-cache: ${{ inputs.no-cache || true }}
          build-args: ${{ inputs.build-args }}
          secrets: |
            AUTH0_SECRET=${{ secrets.AUTH0_SECRET }}
            AUTH0_CLIENT_ID=${{ secrets.AUTH0_CLIENT_ID }}
            AUTH0_CLIENT_SECRET=${{ secrets.AUTH0_CLIENT_SECRET }}
            AUTH0_DOMAIN=${{ secrets.AUTH0_DOMAIN }}
            AUTH0_AUDIENCE=${{ secrets.AUTH0_AUDIENCE }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha
            ${{ inputs.push-image && format('type=registry,ref={0}/{1}/{2}/{3}-{4}:{5}', inputs.container_registry, github.actor, inputs.system_name, inputs.app_name, inputs.environment, github.run_id) || '' }}
          cache-to: |
            type=gha,mode=max
            ${{ inputs.push-image && format('type=registry,ref={0}/{1}/{2}/{3}-{4}:{5},mode=max', inputs.container_registry, github.actor, inputs.system_name, inputs.app_name, inputs.environment, github.run_id) || '' }}
          provenance: false

  notify:
    name: Send notification
    needs: [build]
    if: ${{ always() && inputs.environment != '' }}
    uses: kkho/workflows/.github/workflows/slack-message.yaml@main
    with:
      channel: "#build-${{ inputs.environment }}"
      message: |
        Docker image build for ${{ inputs.app_name }} in ${{ inputs.environment }} completed.
        Status: ${{ needs.build.result == 'success' && '✅ Success' || '❌ Failed' }}
        Repository: ${{ github.repository }}
        Commit: ${{ github.sha }}
        Url: [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
      username: "GitHub Actions"
      icon_emoji: ":github:"
      color: ${{ needs.build.result == 'success' && 'good' || 'danger' }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
